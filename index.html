<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–±–æ—Ä—â–∏–∫ –≤—ã–ø–∏—Å–∫–∏ (v1.30)</title>
    <style>
        body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 900px; margin: 30px auto; background-color: #f4f6f9; color: #333; }
        .container { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        h1 { color: #2c3e50; margin: 0; font-size: 28px; }
        .subtitle { color: #6c757d; font-size: 14px; margin-top: 8px; margin-bottom: 30px; line-height: 1.5; }
        
        /* Drag & Drop Zone */
        .upload-area { 
            border: 2px dashed #cbd5e0; 
            border-radius: 12px; 
            padding: 50px 20px; 
            text-align: center; 
            background: #f8f9fa; 
            transition: 0.2s ease;
            cursor: pointer;
            margin-bottom: 30px;
            user-select: none;
        }
        .upload-area:hover, .upload-area.dragover { border-color: #0d6efd; background: #eef6ff; }
        
        #fileInput { display: none; }

        .upload-icon { font-size: 40px; margin-bottom: 15px; display: block; }
        .upload-text { font-size: 18px; color: #0d6efd; font-weight: 600; display: block; margin-bottom: 5px;}
        .upload-hint { color: #adb5bd; font-size: 13px; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #fff; border: 1px solid #e9ecef; padding: 20px; border-radius: 12px; text-align: center; transition: 0.2s; }
        .stat-val { font-size: 28px; font-weight: 700; color: #2c3e50; margin-bottom: 5px; }
        .stat-label { font-size: 12px; color: #6c757d; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        
        .stat-card.ok { border-color: #20c997; background-color: #e6fcf5; }
        .stat-card.ok .stat-val { color: #0ca678; }

        /* Buttons */
        .main-btn { background-color: #0d6efd; color: white; border: none; padding: 18px 30px; font-size: 16px; font-weight: 600; border-radius: 8px; cursor: pointer; width: 100%; transition: 0.2s; box-shadow: 0 4px 12px rgba(13, 110, 253, 0.2); }
        .main-btn:hover { background-color: #0b5ed7; transform: translateY(-1px); }
        .main-btn:disabled { background-color: #aeb5bc; cursor: not-allowed; opacity: 0.7; box-shadow: none; transform: none; }

        /* Secondary Buttons Container */
        .download-group { 
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            margin-top: 15px; 
        }
        
        .sec-btn {
            border: none; padding: 15px; font-size: 14px; font-weight: 600; border-radius: 8px; cursor: pointer; transition: 0.2s; color: white;
        }
        .btn-app { background-color: #198754; } /* –ó–µ–ª–µ–Ω—ã–π */
        .btn-app:hover { background-color: #157347; }
        
        .btn-stmt { background-color: #0dcaf0; color: #000; } /* –ì–æ–ª—É–±–æ–π */
        .btn-stmt:hover { background-color: #31d2f2; }
        
        /* Console Log */
        #log { background: #1e293b; color: #00ff9d; font-family: "Consolas", "Monaco", monospace; padding: 20px; border-radius: 12px; height: 300px; overflow-y: auto; margin-top: 30px; font-size: 13px; white-space: pre-wrap; line-height: 1.6; border: 1px solid #334155; }
        
        /* Footer Authors */
        .authors { margin-top: 30px; text-align: center; font-size: 13px; color: #6c757d; border-top: 1px solid #eee; padding-top: 20px; }
        .authors a { color: #0d6efd; text-decoration: none; border-bottom: 1px dashed #0d6efd; }
        .authors a:hover { border-bottom-style: solid; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üõ† –°–±–æ—Ä—â–∏–∫ –≤—ã–ø–∏—Å–∫–∏ <span style="font-size: 0.6em; color: #adb5bd; vertical-align: middle;">v1.30</span></h1>
        <div class="subtitle">
            –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è GUID (–ø–æ–¥–º–µ–Ω–∞ –≤ –≤—ã–ø–∏—Å–∫–µ), —Å—Ç—Ä–æ–≥–∏–π —Ñ–∏–ª—å—Ç—Ä –ö–ë–ö, 
            —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–≤—É—Ö —Ñ–∞–π–ª–æ–≤ (–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ + –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤—ã–ø–∏—Å–∫–∞).
        </div>
        
        <input type="file" id="fileInput" multiple accept=".xml">

        <div class="upload-area" id="dropZone">
            <span class="upload-icon">üìÇ</span>
            <span class="upload-text">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –∏–ª–∏ —Ñ–∞–π–ª—ã</span>
            <span class="upload-hint">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞ –≤—Å–µ —Ñ–∞–π–ª—ã (–≤—ã–ø–∏—Å–∫—É, –ø–ª–∞—Ç–µ–∂–∫–∏, —Ä–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏—è) —Å—Ä–∞–∑—É</span>
        </div>

        <div class="stats-grid">
            <div class="stat-card" id="cardStatement">
                <div class="stat-val" id="countStatement">–ù–µ—Ç</div>
                <div class="stat-label">–í—ã–ø–∏—Å–∫–∞</div>
            </div>
            <div class="stat-card" id="cardED">
                <div class="stat-val" id="countED">0</div>
                <div class="stat-label">–ü–ª–∞—Ç–µ–∂–∫–∏</div>
            </div>
            <div class="stat-card" id="cardRSKP">
                <div class="stat-val" id="countRSKP">0</div>
                <div class="stat-label">–†–∞—Å–ø–æ—Ä—è–∂–µ–Ω–∏—è</div>
            </div>
        </div>

        <button id="btnRun" class="main-btn" disabled>üöÄ –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∏ –°–∫–∞—á–∞—Ç—å (–í—Å–µ)</button>
        
        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ (—Å–∫—Ä—ã—Ç—ã) -->
        <div id="dlGroup" class="download-group">
            <button id="btnDlApp" class="sec-btn btn-app">üíæ –°–∫–∞—á–∞—Ç—å –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
            <button id="btnDlStmt" class="sec-btn btn-stmt">üìÑ –°–∫–∞—á–∞—Ç—å –í—ã–ø–∏—Å–∫—É</button>
        </div>
    </div>

    <div id="log">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤...</div>

    <div class="authors">
        –ò–¥–µ—è –∏ —É–ª—É—á—à–µ–Ω–∏—è: <a href="https://github.com/rintaru123" target="_blank">Rintaru123</a><br>
        –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –¥–∏–∑–∞–π–Ω: Gemini 3-pro
    </div>

    <script>
        // === Configuration ===
        const APP_VERSION = "v1.30";

        // === State ===
        const Data = {
            mainGuid: "",
            mainDate: "",
            map: {},           
            docsED: [],        
            docsRSKP: [],      
            statementFound: false,
            statementDoc: null, 
            statementName: "Statement.xml",
            
            // –•—Ä–∞–Ω–∏–ª–∏—â–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–¥–µ–ª—å–Ω–æ–≥–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            finalAppXml: null,
            finalAppName: "",
            finalStmtXml: null,
            finalStmtName: ""
        };

        const logger = (msg, type = "info") => {
            const log = document.getElementById('log');
            let prefix = "> ";
            const span = document.createElement("div");
            if (type === "warn") { prefix = "‚ö†Ô∏è "; span.style.color = "#ffc107"; }
            if (type === "err") { prefix = "‚ùå "; span.style.color = "#ff6b6b"; }
            
            if (type === "success") { 
                prefix = "‚úÖ "; 
                span.style.color = "#00ff9d"; 
                span.style.fontWeight = "bold"; 
            }
            if (type === "date") { 
                prefix = "üìÖ "; 
                span.style.color = "#64b5f6"; 
                span.style.fontWeight = "bold"; 
            }
            
            span.textContent = `${prefix}${msg}`;
            log.appendChild(span);
            log.scrollTop = log.scrollHeight;
        };

        // === HELPERS ===
        function findNode(parent, tagName) {
            if (!parent) return null;
            let list = parent.getElementsByTagName(tagName);
            if (list.length > 0) return list[0];
            const all = parent.getElementsByTagName("*");
            for (let i = 0; i < all.length; i++) {
                if (all[i].localName === tagName) return all[i];
            }
            return null;
        }

        function getVal(parent, path) {
            try {
                const parts = path.split(">").map(s => s.trim());
                let current = parent;
                for (let tag of parts) {
                    current = findNode(current, tag);
                    if (!current) return "";
                }
                return current.textContent?.trim() || "";
            } catch (e) { return ""; }
        }

        function getAttr(parent, path, attrName) {
            try {
                let current = parent;
                if (path) {
                    const parts = path.split(">").map(s => s.trim());
                    for (let tag of parts) {
                        current = findNode(current, tag);
                        if (!current) return "";
                    }
                }
                return current.getAttribute(attrName)?.trim() || "";
            } catch (e) { return ""; }
        }

        function getSafeKpp(val) { return (!val || val.trim() === "") ? "0" : val; }

        function makeTag(tagName, value) {
            if (!value || value === "") return "";
            return `<${tagName}>${value}</${tagName}>`;
        }

        function esc(s) {
            if (!s) return "";
            return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function genKey(num, amount) {
            const sumStr = Math.abs(parseFloat(amount)).toFixed(2);
            return `${num}_${sumStr}`;
        }

        function readFile(file) {
            return new Promise((r, j) => {
                const reader = new FileReader();
                reader.onload = () => r(reader.result);
                reader.onerror = j;
                reader.readAsText(file);
            });
        }

        // === LOGIC: Strict Filter ===
        function findBestMatch(candidates, filePayerAcc, filePayeeAcc) {
            if (!candidates || candidates.length === 0) return null;
            const fPayer = (filePayerAcc || "").trim();
            const fPayee = (filePayeeAcc || "").trim();

            for (let c of candidates) {
                if (c.dirSum === "1") { 
                    if (c.counterPartyAcc && fPayee === c.counterPartyAcc) return c;
                }
                else if (c.dirSum === "0") { 
                    if (c.counterPartyAcc && fPayer === c.counterPartyAcc) return c;
                }
            }
            return candidates[0]; 
        }

        function isIncomeKbk(kbk) {
            if (!kbk || kbk.length !== 20) return false;
            const incomeEndings = ["120", "130", "140", "150", "180"];
            if (incomeEndings.some(end => kbk.endsWith(end))) return true;
            if (kbk.startsWith("1") || kbk.startsWith("000")) return true;
            return false;
        }

        function findKbkComplex(text, dirSum) {
            if (!text) return null;
            const regex = /\(([^)]+)\)/g;
            let match;
            let candidates = [];
            while ((match = regex.exec(text)) !== null) {
                const parts = match[1].split(/[;,]/);
                parts.forEach(part => {
                    const clean = part.replace(/[^a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9]/g, '');
                    if (clean.length === 20) candidates.push(clean);
                });
            }

            if (candidates.length === 0) return null;

            if (dirSum === "1") { 
                const expenseKbk = candidates.find(c => c.startsWith("9"));
                return expenseKbk || null; 
            } else {
                const priorityKbk = candidates.find(c => isIncomeKbk(c));
                return priorityKbk || null;
            }
        }

        function getAddClassAndKosgu(text, kbk, dirSum) {
            if (!text || !kbk) return "";
            const escKbk = kbk.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
            const regexGroup = new RegExp(`\\(${escKbk}(.*?)\\)`, "i");
            const matchGroup = text.match(regexGroup);
            if (!matchGroup) return "";

            const innerContent = matchGroup[1]; 
            let addClass = "";
            
            const parts = innerContent.split(/[;,]/);
            if (parts.length > 1 && parts[1].trim() !== "") {
                addClass = parts[1].trim();
            } else if (innerContent.trim().length > 1) {
                addClass = innerContent.replace(/[;,]/, "").trim();
            }

            if (dirSum === "0") return addClass;
            else {
                let kosgu = "";
                const groupEndIndex = matchGroup.index + matchGroup[0].length;
                const textAfter = text.substring(groupEndIndex);
                const regexKosgu = /^\s*\(([^)]+)\)/;
                const matchKosgu = textAfter.match(regexKosgu);
                if (matchKosgu) kosgu = matchKosgu[1]; 

                if (addClass && kosgu) return `${addClass}(${kosgu})`;
                else if (!addClass && kosgu) return `(${kosgu})`;
                else if (addClass && !kosgu) return addClass;
                return "";
            }
        }

        function getTypeKBK(dirSum) { return (dirSum === "1") ? "10" : "20"; }

        // === AUTO SORT LOGIC ===
        const handleFiles = async (files) => {
            if (files.length === 0) return;

            // Reset UI
            Data.mainGuid = "";
            Data.mainDate = "";
            Data.map = {};
            Data.docsED = [];
            Data.docsRSKP = [];
            Data.statementFound = false;
            Data.statementDoc = null;
            document.getElementById('dlGroup').style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –¥–æ–ø –∫–Ω–æ–ø–∫–∏
            
            const logEl = document.getElementById('log');
            logEl.innerHTML = ""; 

            logger(`--- –ê–Ω–∞–ª–∏–∑ ${files.length} —Ñ–∞–π–ª–æ–≤ ---`);
            const parser = new DOMParser();

            for (const file of files) {
                try {
                    const text = await readFile(file);
                    const doc = parser.parseFromString(text, "text/xml");
                    
                    if (doc.querySelector("parsererror")) {
                        logger(`–û—à–∏–±–∫–∞ XML: ${file.name}`, "err");
                        continue;
                    }

                    const rootName = doc.documentElement.nodeName;

                    if (doc.querySelector("StmInfrmtn") || doc.querySelector("StmInfrmtn_TF") || rootName.includes("Statement")) {
                        processStatement(doc, file.name);
                    }
                    else if (rootName === "ED101" || rootName === "ED108") {
                        Data.docsED.push({ name: file.name, xmlDoc: doc });
                    }
                    else if (rootName.includes("MSC_TransfOrderAcc")) {
                        Data.docsRSKP.push({ name: file.name, xmlDoc: doc });
                    }
                } catch (err) {
                    logger(`–°–±–æ–π —á—Ç–µ–Ω–∏—è ${file.name}: ${err.message}`, "err");
                }
            }
            updateUI();
            document.getElementById('fileInput').value = null; 
        };

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', () => { fileInput.click(); });
        fileInput.addEventListener('change', (e) => { handleFiles(Array.from(e.target.files)); });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
        });
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
        });
        
        dropZone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(Array.from(files));
        }, false);


        function processStatement(xml, fileName) {
            if (Data.statementFound) {
                logger(`–ù–∞–π–¥–µ–Ω–∞ –µ—â–µ –æ–¥–Ω–∞ –≤—ã–ø–∏—Å–∫–∞ (${fileName}). –ë–µ—Ä—É –ø–æ—Å–ª–µ–¥–Ω—é—é.`, "warn");
            }
            
            try {
                Data.statementDoc = xml;
                Data.statementName = fileName;
                
                Data.mainDate = getVal(xml, "TtlPrt_DocDate");
                let stmInfo = findNode(xml, "StmInfrmtn_TF") || findNode(xml, "StmInfrmtn");
                Data.mainGuid = getVal(stmInfo, "GUID");

                let itemsList = xml.getElementsByTagName("*");
                let items = [];
                for(let i=0; i<itemsList.length; i++) {
                    if (itemsList[i].localName === "Oper_BudData_ITEM") items.push(itemsList[i]);
                }

                Data.map = {};
                let count = 0;

                items.forEach(item => {
                    const num = getVal(item, "DocNum");
                    const guid = getVal(item, "DocGUID");
                    const operType = getVal(item, "OperType") || "01";
                    
                    const amOut = parseFloat(getVal(item, "AmountOut") || "0");
                    const amIn = parseFloat(getVal(item, "AmountIn") || "0");
                    const realSum = amOut + amIn;
                    
                    let dirSum;
                    let counterPartyAcc = "";

                    if (amOut > 0) {
                        dirSum = "1"; // –†–∞—Å—Ö–æ–¥
                        counterPartyAcc = getVal(item, "RecipAcc");
                    } else {
                        dirSum = "0"; // –î–æ—Ö–æ–¥
                        counterPartyAcc = getVal(item, "SendAcc");
                    }

                    if (num && guid) {
                        const key = genKey(num, realSum);
                        if (!Data.map[key]) Data.map[key] = [];
                        Data.map[key].push({ node: item, originalGuid: guid, operType, dirSum, counterPartyAcc });
                        count++;
                    }
                });

                Data.statementFound = true;
                logger(`–î–∞—Ç–∞ –≤—ã–ø–∏—Å–∫–∏: ${Data.mainDate}`, "date");
                logger(`–í—ã–ø–∏—Å–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞: ${count} —Å—Ç—Ä–æ–∫`, "success");

            } catch (err) {
                logger(`–û—à–∏–±–∫–∞ –≤—ã–ø–∏—Å–∫–∏: ${err.message}`, "err");
            }
        }

        function updateUI() {
            document.getElementById('countED').textContent = Data.docsED.length;
            document.getElementById('countRSKP').textContent = Data.docsRSKP.length;
            
            const stDiv = document.getElementById('countStatement');
            const cardSt = document.getElementById('cardStatement');
            
            if (Data.statementFound) {
                stDiv.textContent = "OK";
                cardSt.classList.add("ok");
            } else {
                stDiv.textContent = "–ù–µ—Ç";
                cardSt.classList.remove("ok");
            }

            const hasFiles = (Data.docsED.length > 0 || Data.docsRSKP.length > 0);
            const btn = document.getElementById('btnRun');
            btn.disabled = !(Data.statementFound && hasFiles);
        }

        // === UPDATE GUID IN STATEMENT ===
        function updateStatementGuid(statementNode, newGuid) {
            try {
                let guidNode = findNode(statementNode, "DocGUID");
                if (guidNode) {
                    guidNode.textContent = newGuid;
                }
            } catch(e) {
                logger("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è GUID –≤ –≤—ã–ø–∏—Å–∫–µ", "err");
            }
        }

        // === GENERATE RESULT ===
        document.getElementById('btnRun').addEventListener('click', () => {
            logger("‚öôÔ∏è –°–±–æ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è GUID...");
            
            let resultPD = "";
            let resultOrder = "";
            let totalSum = 0;
            let successCount = 0;

            // 1. ED
            for (const item of Data.docsED) {
                try {
                    const doc = item.xmlDoc;
                    let ed = findNode(doc, "ED101") || findNode(doc, "ED108");
                    let fileGuid = ed.getAttribute("GUID");

                    const docNo = getAttr(ed, "AccDoc", "AccDocNo");
                    const rawSum = parseFloat(ed.getAttribute("Sum") || "0");
                    const sumRub = rawSum / 100;
                    const key = genKey(docNo, sumRub);
                    const candidates = Data.map[key];

                    if (!candidates) { 
                        logger(`–ü—Ä–æ–ø—É—Å–∫ ED ‚Ññ${docNo}: –Ω–µ—Ç –≤ –≤—ã–ø–∏—Å–∫–µ`, "warn"); 
                        continue; 
                    }

                    const p = findNode(ed, "Payer");
                    const r = findNode(ed, "Payee");
                    const filePayerAcc = p?.getAttribute("PersonalAcc");
                    const filePayeeAcc = r?.getAttribute("PersonalAcc");

                    const info = findBestMatch(candidates, filePayerAcc, filePayeeAcc);
                    
                    let finalGuid = fileGuid;
                    if (!finalGuid) {
                         finalGuid = info.originalGuid;
                    } else {
                        updateStatementGuid(info.node, finalGuid);
                    }

                    const docDate = getAttr(ed, "AccDoc", "AccDocDate");
                    const purp = getVal(ed, "Purpose");
                    
                    const foundKbk = findKbkComplex(purp, info.dirSum);
                    let kbkBlock = "";
                    let addClassTag = "";

                    if (foundKbk) {
                        const typeVal = getTypeKBK(info.dirSum);
                        kbkBlock = `<KBK>${foundKbk}</KBK><TYPE_KBK value="${typeVal}"></TYPE_KBK>`;
                        const addKlassVal = getAddClassAndKosgu(purp, foundKbk, info.dirSum);
                        addClassTag = makeTag("ADD_KLASS", addKlassVal); 
                    }

                    const pBank = findNode(p, "Bank");
                    const rBank = findNode(r, "Bank");

                    resultPD += `
        <Inf_PD_ITEM>
            <Nom_PP>${docNo}</Nom_PP>
            <Date_PP>${docDate}</Date_PP>
            <Sum_PP>${sumRub.toFixed(2)}</Sum_PP>
            <Vid_Pay value="0"></Vid_Pay>
            <Date_PP_IN>${docDate}</Date_PP_IN>
            <Date_PP_OUT>${docDate}</Date_PP_OUT>
            <VID_Oper>${info.operType}</VID_Oper>
            <Inf_PAY>
                <INN_PAY>${p?.getAttribute("INN")||""}</INN_PAY>
                <KPP_PAY>${getSafeKpp(p?.getAttribute("KPP"))}</KPP_PAY>
                <CName_PAY>${esc(getVal(p, "Name"))}</CName_PAY>
            </Inf_PAY>
            <Bank_PAY>
                <BS_PAY>${filePayerAcc||""}</BS_PAY>
                <BIC_PAY>${pBank?.getAttribute("BIC")||""}</BIC_PAY>
                <BS_KS_PAY>${pBank?.getAttribute("CorrespAcc")||""}</BS_KS_PAY>
            </Bank_PAY>
            <Inf_RCP>
                <INN_PAY>${r?.getAttribute("INN")||""}</INN_PAY>
                <KPP_PAY>${getSafeKpp(r?.getAttribute("KPP"))}</KPP_PAY>
                <CName_PAY>${esc(getVal(r, "Name"))}</CName_PAY>
            </Inf_RCP>
            <Bank_RCP>
                <BS_PAY>${filePayeeAcc||""}</BS_PAY>
                <BIC_PAY>${rBank?.getAttribute("BIC")||""}</BIC_PAY>
                <BS_KS_PAY>${rBank?.getAttribute("CorrespAcc")||""}</BS_KS_PAY>
            </Bank_RCP>
            <Order_PAY>5</Order_PAY>
            <Purpose>${esc(purp)}</Purpose>
            <Date_IN_TOFK>${Data.mainDate}</Date_IN_TOFK>
            <GUID>${finalGuid}</GUID>
            <Inf_KBK>
                <Inf_KBK_ITEM>
                    ${kbkBlock}
                    ${addClassTag}
                    <SUM>${sumRub.toFixed(2)}</SUM>
                    <Dir_Sum value="${info.dirSum}"></Dir_Sum>
                </Inf_KBK_ITEM>
            </Inf_KBK>
        </Inf_PD_ITEM>`;
                    
                    totalSum += sumRub;
                    successCount++;
                } catch (e) { logger(`–û—à–∏–±–∫–∞ ED ${item.name}: ${e.message}`, "err"); }
            }

            // 2. RSKP
            for (const item of Data.docsRSKP) {
                try {
                    const root = item.xmlDoc.documentElement;
                    let fileGuid = getVal(root, "GUID");

                    const docNo = getVal(root, "AccDoc_DocNum");
                    const sum = parseFloat(getVal(root, "BasicRequisites_PaySum") || "0");
                    const key = genKey(docNo, sum);
                    const candidates = Data.map[key];

                    if (!candidates) { 
                        logger(`–ü—Ä–æ–ø—É—Å–∫ –†–°–ö–ü ‚Ññ${docNo}: –Ω–µ—Ç –≤ –≤—ã–ø–∏—Å–∫–µ`, "warn"); 
                        continue; 
                    }

                    const filePayerAcc = getVal(root, "Payer_AccNum");
                    const filePayeeAcc = getVal(root, "Recip_AccNum");
                    const info = findBestMatch(candidates, filePayerAcc, filePayeeAcc);

                    let finalGuid = fileGuid;
                    if (!finalGuid) {
                         finalGuid = info.originalGuid;
                    } else {
                        updateStatementGuid(info.node, finalGuid);
                    }

                    const purp = getVal(root, "DepInfo_PayPurpose");
                    const xmlKbk = getVal(root, "FAHTeh > FAHTeh_ITEM > Payer_KBK");
                    
                    const foundKbk = findKbkComplex(purp, info.dirSum);
                    
                    let finalKbk = foundKbk;
                    if (!finalKbk && xmlKbk) {
                        if (info.dirSum === "1") {
                            finalKbk = xmlKbk;
                        } else {
                            if (isIncomeKbk(xmlKbk)) {
                                finalKbk = xmlKbk;
                            } else {
                                finalKbk = null; 
                            }
                        }
                    }

                    const typeVal = getTypeKBK(info.dirSum);

                    let rskpKbkBlock = "";
                    if (finalKbk) {
                         const addKlassVal = getAddClassAndKosgu(purp, finalKbk, info.dirSum);
                         const tagKBK = makeTag("Order_KBK", finalKbk);
                         const tagType = `<Order_Type_KBK value="${typeVal}"></Order_Type_KBK>`;
                         const tagAdd = makeTag("Order_Add_Klass", addKlassVal);
                         rskpKbkBlock = `${tagKBK}\n                    ${tagType}\n                    ${tagAdd}`;
                    }

                    const docDate = getVal(root, "AccDoc_DocDate");
                    const execDate = getVal(root, "ExecDate");
                    const oktmo = getVal(root, "DepInfo_TAX_OKTMO");
                    const codeReven = getVal(root, "DepInfo_TAX_KBK");
                    
                    let status = getVal(root, "DepInfo_TAX_DrawStat");
                    let basis = getVal(root, "DepInfo_TAX_PayReason");
                    let period = getVal(root, "DepInfo_TAX_Period");
                    let taxDocNo = getVal(root, "DepInfo_TAX_DocNo");
                    let taxDocDate = getVal(root, "DepInfo_TAX_DocDate");

                    if (codeReven || oktmo) {
                        if (!status) status = "0";
                        if (!basis) basis = "0";
                        if (!period) period = "0";
                        if (!taxDocNo) taxDocNo = "0";
                        if (!taxDocDate) taxDocDate = "0";
                    }

                    resultOrder += `
        <Inf_Order_ITEM>
            <GUID_PrimDoc>${finalGuid}</GUID_PrimDoc>
            <Order_Type>0</Order_Type>
            <Order_Num>${docNo}</Order_Num>
            <Order_DateComp>${docDate}</Order_DateComp>
            <Order_DateExec>${execDate}</Order_DateExec>
            <Amount_Curr>${sum.toFixed(2)}</Amount_Curr>
            <CurrCode_OKV>643</CurrCode_OKV>
            <Amount_Rub>${sum.toFixed(2)}</Amount_Rub>
            <Purpose_Pay>${esc(purp)}</Purpose_Pay>
            <UIN_Char>0</UIN_Char>
            ${makeTag("OPERATION_ID", getVal(root, "OperationID"))}
            <Actual_Payer>
                <ActPayer_INN>${getVal(root, "Payer_INN")}</ActPayer_INN>
                <ActPayer_KPP>${getSafeKpp(getVal(root, "Payer_KPP"))}</ActPayer_KPP>
                <Payer_Name>${esc(getVal(root, "Payer_Name"))}</Payer_Name>
                ${makeTag("Payer_PersAccNum", filePayerAcc)}
                <Payer_AccNum>${getVal(root, "Payer_CheckAcc")}</Payer_AccNum>
                <PayServOrg_Name>${esc(getVal(root, "Payer_BankName"))}</PayServOrg_Name>
                <PayServOrg_BIK>${getVal(root, "Payer_BIK")}</PayServOrg_BIK>
                <PayServOrg_AccNum>${getVal(root, "Payer_CorrAcc")}</PayServOrg_AccNum>
            </Actual_Payer>
            <Actual_Recip>
                <Recip_Name>${esc(getVal(root, "Recip_Name"))}</Recip_Name>
                ${makeTag("Recip_PersAccNum", filePayeeAcc)}
                <Recip_INN>${getVal(root, "Recip_INN")}</Recip_INN>
                <Recip_KPP>${getSafeKpp(getVal(root, "Recip_KPP"))}</Recip_KPP>
                <RecServOrg_AccNum>${getVal(root, "Recip_CorrAcc")}</RecServOrg_AccNum>
                <RecServOrg_Name>${esc(getVal(root, "Recip_BankName"))}</RecServOrg_Name>
                <RecServOrg_BIK>${getVal(root, "Recip_BIK")}</RecServOrg_BIK>
                <Recip_AccNum>${getVal(root, "Recip_CheckAcc")}</Recip_AccNum>
            </Actual_Recip>
            <Code_Reven>${codeReven}</Code_Reven>
            ${makeTag("Code_OKTMO", oktmo)}
            <Payer_status>${status}</Payer_status>
            <Basis_Pay>${basis}</Basis_Pay>
            <Tax_Period>${period}</Tax_Period>
            <DocBase_Num>${taxDocNo}</DocBase_Num>
            <DocBase_Date>${taxDocDate}</DocBase_Date>
            <Inf_Order_KBK>
                <Inf_Order_KBK_ITEM>
                    ${rskpKbkBlock}
                    <Order_Sum>${sum.toFixed(2)}</Order_Sum>
                    <Order_Dir_Sum value="${info.dirSum}"></Order_Dir_Sum>
                    <Order_Type_Ap>0</Order_Type_Ap>
                </Inf_Order_KBK_ITEM>
            </Inf_Order_KBK>
        </Inf_Order_ITEM>`;
                    
                    totalSum += sum;
                    successCount++;
                } catch (e) { logger(`–û—à–∏–±–∫–∞ RSKP ${item.name}: ${e.message}`, "err"); }
            }

            // --- SAVE PREPARATION ---
            const blockPD = resultPD ? `<Inf_PD>${resultPD}\n    </Inf_PD>` : "";
            const blockOrder = resultOrder ? `<Inf_Order>${resultOrder}\n    </Inf_Order>` : "";

            const finalXML = `<?xml version ="1.0" encoding="UTF-8"?>
<self:Inf_Pay_Doc metaType="formular" versionID="4.0" xsi:schemaLocation="http://www.roskazna.ru/eb/domain/Inf_Pay_Doc/formular formulars.xsd" xmlns:self="http://www.roskazna.ru/eb/domain/Inf_Pay_Doc/formular" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <GUID_Doc>${Data.mainGuid}</GUID_Doc>
    <Date>${Data.mainDate}</Date>
    <Code_Doc value="VQ"></Code_Doc>
    <Vid_Otch value="0"></Vid_Otch>
    <Kol_Doc>${successCount}</Kol_Doc>
    <Sum_Doc>${totalSum.toFixed(2)}</Sum_Doc>
    ${blockPD}
    ${blockOrder}
</self:Inf_Pay_Doc>`;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
            Data.finalAppXml = finalXML;
            Data.finalAppName = `–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫ –≤—ã–ø–∏—Å–∫–µ –æ—Ç ${Data.mainDate}.xml`;

            const serializer = new XMLSerializer();
            Data.finalStmtXml = serializer.serializeToString(Data.statementDoc);
            Data.finalStmtName = `–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è_${Data.statementName}`;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
            document.getElementById('dlGroup').style.display = 'grid';

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
            download(Data.finalAppXml, Data.finalAppName);
            setTimeout(() => {
                download(Data.finalStmtXml, Data.finalStmtName);
                logger(`üèÅ –ì–æ—Ç–æ–≤–æ! –°–∫–∞—á–∞–Ω–æ 2 —Ñ–∞–π–ª–∞. –ú–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ –∫–Ω–æ–ø–∫–∞–º–∏ –Ω–∏–∂–µ.`, "success");
            }, 800);
        });

        // --- HANDLERS FOR SEPARATE BUTTONS ---
        document.getElementById('btnDlApp').addEventListener('click', () => {
            if (Data.finalAppXml) download(Data.finalAppXml, Data.finalAppName);
        });

        document.getElementById('btnDlStmt').addEventListener('click', () => {
            if (Data.finalStmtXml) download(Data.finalStmtXml, Data.finalStmtName);
        });

        function download(content, name) {
            const blob = new Blob([content], {type: "text/xml"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = name;
            a.click();
        }
        // === UPDATE CHECKER ===
        const GITHUB_USERNAME = "rintaru123";
        const REPO_NAME = "EBP-account-statement-packager"; // <-- –í–ü–ò–®–ò –°–Æ–î–ê –ò–ú–Ø –†–ï–ü–û–ó–ò–¢–û–†–ò–Ø
        const VERSION_JSON_URL = `https://${GITHUB_USERNAME}.github.io/${REPO_NAME}/version.json`;

        async function checkForUpdates() {
            try {
                // –î–æ–±–∞–≤–ª—è–µ–º timestamp, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –Ω–µ –∫–µ—à–∏—Ä–æ–≤–∞–ª JSON –∏ –≤—Å–µ–≥–¥–∞ –±—Ä–∞–ª —Å–≤–µ–∂–∏–π
                const response = await fetch(VERSION_JSON_URL + '?t=' + new Date().getTime());
                if (!response.ok) return;

                const data = await response.json();
                const latestVersion = data.version;

                // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (—Å—Ç—Ä–æ–≥–æ–µ –Ω–µ—Ä–∞–≤–µ–Ω—Å—Ç–≤–æ)
                // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –≤ –∫–æ–¥–µ (APP_VERSION) –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–æ–π, —á—Ç–æ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
                if (latestVersion !== APP_VERSION) {
                    showUpdateNotification(latestVersion, data.message, data.download_url);
                } else {
                    console.log("–£ –≤–∞—Å –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è:", APP_VERSION);
                }
            } catch (e) {
                console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", e);
            }
        }

        function showUpdateNotification(ver, msg, url) {
            // –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Å–∏–≤—É—é –ø–ª–∞—à–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const div = document.createElement('div');
            div.style.cssText = `
                position: fixed; bottom: 20px; right: 20px; 
                background: #fff; border-left: 5px solid #0d6efd;
                padding: 15px 20px; border-radius: 8px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.2);
                font-family: "Segoe UI", sans-serif; z-index: 1000;
                animation: slideIn 0.5s ease-out;
            `;
            
            div.innerHTML = `
                <div style="font-weight:bold; font-size:16px; margin-bottom:5px; color:#333;">
                    –î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: <span style="color:#0d6efd">${ver}</span>
                </div>
                <div style="font-size:13px; color:#666; margin-bottom:10px;">${msg}</div>
                <a href="${url}" target="_blank" style="
                    display:inline-block; background:#0d6efd; color:white; 
                    text-decoration:none; padding:6px 12px; border-radius:4px; 
                    font-size:13px; font-weight:600;">–°–∫–∞—á–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</a>
                <button onclick="this.parentElement.remove()" style="
                    background:none; border:none; color:#999; cursor:pointer; 
                    margin-left:10px; font-size:12px;">–ó–∞–∫—Ä—ã—Ç—å</button>
            `;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            const style = document.createElement('style');
            style.innerHTML = `@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }`;
            document.head.appendChild(style);
            
            document.body.appendChild(div);
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        checkForUpdates();
    </script>
</body>
</html>